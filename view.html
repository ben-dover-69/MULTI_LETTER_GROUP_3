<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>View Letter</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* Letter title animation */
#letterTitle {
  font-size: 28px;
  text-align: center;
  margin-bottom: 15px;
  font-weight: bold;
}

/* Letter body wrapping */
.letter .body {
  white-space: pre-wrap;
  word-wrap: break-word;
  overflow-wrap: break-word;
  max-height: 500px;
  overflow-y: auto;
  padding: 10px 0;
}

/* Wax seal */
.waxSeal {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  position: absolute;
  bottom: 40px;
  right: 40px;
  opacity: 0;
  transform: scale(0.5);
  box-shadow: 0 0 12px rgba(0,0,0,0.3);
  transition: opacity 0.6s ease, transform 0.6s ease;
}
.waxSeal.show { opacity: 1; transform: scale(1); }

.waxSeal span {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  height: 100%;
  font-weight: bold;
  font-size: 22px;
  color: white;
  background-color: #b30000; /* default red wax */
  border-radius: 50%; /* circle */
}

/* Letter container */
.letter-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  padding-top: 20px;
}

/* --- Letter backgrounds per type --- */
body.love { background: #8B0000; }
body.birthday { background: #FFD700; }
body.formal { background: #C0C0C0; }
body.informal { background: #32CD32; }
body.invitation { background: #BA55D3; }
body.apology { background: #FF6347; }
body.farewell { background: #00CED1; }

/* Preserve line breaks */
.letter .body {
  white-space: pre-wrap;
}
</style>
</head>
<body class="love">

<!-- ENVELOPE -->
<div id="envelopeScreen">
  <div class="envelope">
    <div class="env-back"></div>
    <div class="env-front"></div>
    <div class="env-flap"></div>
  </div>
  <button id="openLetterBtn">Open Letter</button>
</div>

<!-- MAIN VIEW -->
<div id="app" class="hidden">

  <!-- LETTER -->
  <div class="letter-container">
    <div id="letter" class="letter">
      <p class="date" id="date"></p>

      <!-- Letter Title inside the letter box -->
      <h1 id="letterTitle"></h1>

      <p class="dear">Dear <span id="receiverName" class="editable-box" contenteditable="false">Receiver Name</span>,</p>

      <!-- Letter body -->
      <div id="body" class="body editable-box" contenteditable="false">
        This is the body of the letter.
      </div>

      <p class="closing">Sincerely,<br>
        <span id="senderName" class="editable-box" contenteditable="false">Sender Name</span>
      </p>

      <div id="waxSeal" class="waxSeal"><span id="waxInitials"></span></div>
    </div>
  </div>

  <!-- BOTTOM CONTROLS -->
  <div class="bottom-controls">
    <div class="action-buttons">
      <button id="exportBtn">Export PDF</button>
      <button id="musicToggle"> Play Music</button>
    </div>
  </div>
</div>

<audio id="music" loop></audio>

<script>
// =========================
// ELEMENTS
// =========================
const openBtn = document.getElementById("openLetterBtn");
const envelope = document.querySelector(".envelope");
const envelopeScreen = document.getElementById("envelopeScreen");
const app = document.getElementById("app");
const waxSeal = document.getElementById("waxSeal");
const waxInitials = document.getElementById("waxInitials");
const letter = document.getElementById("letter");
const music = document.getElementById("music");
const musicToggle = document.getElementById("musicToggle");
const exportBtn = document.getElementById("exportBtn");
const dateEl = document.getElementById("date");
const bodyEl = document.getElementById("body");
const letterTitleEl = document.getElementById("letterTitle");
const receiverNameEl = document.getElementById("receiverName");
const senderNameEl = document.getElementById("senderName");

// =========================
// DEFAULTS
// =========================
const defaultBodies = {
  love: "This letter is written with love and sincerity...",
  birthday: "Wishing you a day full of joy and surprises!",
  formal: "This letter is written to formally communicate an important matter.",
  informal: "Just sharing some casual thoughts and greetings.",
  invitation: "We would love for you to join us at this special event.",
  apology: "I am deeply sorry and hope you can forgive me.",
  farewell: "This letter is to say farewell with gratitude and memories."
};

const letterTitles = {
  love: "A Letter From My Heart ðŸ’–",
  birthday: "Happy Birthday Wishes ðŸŽ‰",
  formal: "Formal Letter ðŸ“",
  informal: "Just Saying Hello ðŸ‘‹",
  invitation: "Youâ€™re Invited ðŸŽ€",
  apology: "A Sincere Apology ðŸ™",
  farewell: "Saying Goodbye ðŸ‘‹"
};

const typeTitleFonts = {
  love: "'Dancing Script', cursive",
  birthday: "'Libre Baskerville', serif",
  formal: "'Cormorant Garamond', serif",
  informal: "'Libre Baskerville', serif",
  invitation: "'Playfair Display', serif",
  apology: "'Cormorant Garamond', serif",
  farewell: "'Libre Baskerville', serif"
};

const musicFiles = {
  love: "https://ben-dover-69.github.io/MULTI_LETTER_GROUP_3/kuped.mp3",
  birthday: "https://ben-dover-69.github.io/MULTI_LETTER_GROUP_3/bdaysmegs.mp3",
  formal: "https://ben-dover-69.github.io/MULTI_LETTER_GROUP_3/peynknwite.mp3",
  informal: "",
  invitation: "",
  apology: "",
  farewell: "https://ben-dover-69.github.io/MULTI_LETTER_GROUP_3/farewell.mp3"
};

// =========================
// GET URL PARAMETERS
// =========================
const params = new URLSearchParams(window.location.search);
const receiver = params.get("receiver");
const sender = params.get("sender");
const type = params.get("type") || "love";
const bodyEncoded = params.get("body"); // Base64-encoded
const fontFamily = params.get("fontFamily");
const fontSize = params.get("fontSize");
const fontColor = params.get("fontColor");

// =========================
// BASE64 DECODER
// =========================
function decodeContent(str) {
  try {
    return decodeURIComponent(escape(atob(str)));
  } catch(e) {
    return str; // fallback
  }
}

// =========================
// APPLY LETTER CONTENT
// =========================
letterTitleEl.textContent = letterTitles[type];
letterTitleEl.style.fontFamily = typeTitleFonts[type] || "'Arial', sans-serif";

bodyEl.innerHTML = bodyEncoded ? decodeContent(bodyEncoded) : defaultBodies[type];
bodyEl.style.fontFamily = fontFamily || "'Arial', sans-serif";
bodyEl.style.fontSize = (fontSize ? fontSize + "px" : "16px");
bodyEl.style.color = fontColor || "#000";

if(receiver) receiverNameEl.textContent = receiver;
if(sender) senderNameEl.textContent = sender;

// Wax initials
if(sender){
  const initials = sender.split(' ').map(n => n[0].toUpperCase()).join('');
  waxInitials.textContent = initials || "??";
} else {
  waxInitials.textContent = "??";
}

// Date
dateEl.textContent = new Date().toDateString();

// Apply background color based on type
document.body.className = type;

// =========================
// OPEN ENVELOPE
// =========================
openBtn.onclick = () => {
  envelope.classList.add("open");
  const flap = document.querySelector(".env-flap");
  flap.style.transition = "transform 0.7s ease";
  flap.style.transform = "rotateX(180deg)";

  setTimeout(() => {
    envelopeScreen.style.display = "none";
    app.classList.remove("hidden");

    // Wax seal animation
    setTimeout(() => waxSeal.classList.add("show"), 500);

    // Play music
    music.src = musicFiles[type] || musicFiles.love;
    music.play();
    updateMusicButton();
  }, 700);
};

// =========================
// MUSIC TOGGLE
// =========================
function updateMusicButton() {
  if(music.paused){
    musicToggle.textContent = ' Play Music';
  } else {
    musicToggle.textContent = ' Pause Music';
  }
}
musicToggle.onclick = () => {
  if(music.paused) music.play();
  else music.pause();
  updateMusicButton();
};
updateMusicButton();

// =========================
// EXPORT PDF
// =========================
exportBtn.onclick = () => html2pdf().from(letter).save("letter.pdf");

</script>

</body>
</html>