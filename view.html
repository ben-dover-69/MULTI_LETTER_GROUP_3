<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>View Letter</title>

<link rel="stylesheet" href="https://ben-dover-69.github.io/MULTI_LETTER_GROUP_3/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body class="love">

<!-- ENVELOPE -->
<div id="envelopeScreen">
  <div class="envelope">
    <div class="env-back"></div>
    <div class="env-front"></div>
    <div class="env-flap"></div>
  </div>
  <button id="openLetterBtn">Open Letter</button>
</div>

<!-- MAIN VIEW -->
<div id="app" class="hidden">

  <div class="letter-container">
    <div id="letter" class="letter">

      <p class="date" id="date"></p>

      <p class="dear">
        Dear <span id="receiverName">Receiver Name</span>,
      </p>

      <h1 id="title">Letter Title</h1>

      <div id="body" class="body">
        This is the body of the letter.
      </div>

      <p class="closing">
        Sincerely,<br>
        <span id="senderName">Sender Name</span>
      </p>

      <div id="waxSeal" class="waxSeal"></div>
    </div>
  </div>

  <div class="bottom-controls">
    <div class="action-buttons">
      <button id="exportBtn">Export PDF</button>
      <button id="musicToggle">▶ Play Music</button>
    </div>
  </div>
</div>

<audio id="music" loop></audio>

<script>
  const openBtn = document.getElementById("openLetterBtn");
  const envelopeScreen = document.getElementById("envelopeScreen");
  const app = document.getElementById("app");
  const waxSeal = document.getElementById("waxSeal");
  const music = document.getElementById("music");
  const musicToggle = document.getElementById("musicToggle");
  const exportBtn = document.getElementById("exportBtn");

  document.getElementById("date").textContent = new Date().toDateString();

  // ===============================
  // ✅ FIX — READ & DECODE CONTENT
  // ===============================
  const params = new URLSearchParams(window.location.search);

  const receiver = params.get("receiver_name");
  const sender = params.get("sender_name");
  const title = params.get("letter_title");
  const type = params.get("letter_type");
  const encodedBody = params.get("letter_body_encoded");

  function decodeContent(encoded) {
    try {
      return decodeURIComponent(escape(atob(encoded)));
    } catch {
      return "";
    }
  }

  if (receiver) document.getElementById("receiverName").textContent = receiver;
  if (sender) document.getElementById("senderName").textContent = sender;
  if (title) document.getElementById("title").textContent = title;
  if (encodedBody) document.getElementById("body").innerHTML = decodeContent(encodedBody);
  if (type) document.body.className = type;

  // MUSIC PER LETTER
  const musicFiles = {
    love: "kuped.mp3",
    birthday: "bdaysmegs.mp3",
    formal: "peynknwite.mp3",
    informal: "informal.mp3",
    farewell: "farewell.mp3"
  };

  openBtn.onclick = () => {
    document.querySelector(".env-flap").style.transform = "rotateX(180deg)";
    setTimeout(() => {
      envelopeScreen.style.display = "none";
      app.classList.remove("hidden");
      waxSeal.classList.add("show");

      music.src = musicFiles[type] || musicFiles.love;
      music.play();
      musicToggle.textContent = "⏸ Pause Music";
    }, 700);
  };

  musicToggle.onclick = () => {
    if (music.paused) {
      music.play();
      musicToggle.textContent = "⏸ Pause Music";
    } else {
      music.pause();
      musicToggle.textContent = "▶ Play Music";
    }
  };

  exportBtn.onclick = () => html2pdf().from(document.getElementById("letter")).save("letter.pdf");
</script>

</body>
</html>